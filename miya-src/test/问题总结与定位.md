# 问题清单与具体定位

## 当前状态
- 截至 2026-02-19，本文件原列问题已全部修复并回归通过。
- 2026-02-19 六维审计新增 1 个高风险问题，已修复并补测通过。

## 已修复问题（含定位）

1. `opencode debug config/skill` schema 报错
- 修复定位: `miya-src/opencode.json`
- 修复内容: 改为 OpenCode config schema（`https://opencode.ai/config.json`）并使用 `plugin` 配置。

2. 分类测试脚本空目录失败
- 修复定位:
  - `miya-src/test/integration/integration-smoke.test.ts`
  - `miya-src/test/regression/regression-bridge.test.ts`
  - `miya-src/test/adversarial/adversarial-bridge.test.ts`
  - `miya-src/test/performance/performance-smoke.test.ts`
  - `miya-src/test/e2e/e2e-smoke.test.ts`
- 修复内容: 补齐 5 个分类目录测试入口，脚本可执行。

3. 覆盖率脚本 reporter 不兼容 Bun
- 修复定位: `miya-src/package.json`
- 修复内容: `test:coverage`、`test:coverage:core` 从 `html` 改为 `text + lcov`。

4. 集成报告脚本失败（runtime 超时/daemon_ws_closed）
- 修复定位: `miya-src/tools/run-integration-suite.ts`
- 修复内容: 统一执行 `test/integration`，增加 timeout，默认使用 `MIYA_MULTIMODAL_TEST_MODE=1` 冒烟路径，报告稳定生成。

5. `doc:lint` 与 `opencode.json` 新口径冲突
- 修复定位: `miya-src/tools/doc-lint.ts`
- 修复内容: 当 `opencode.json` 为 config schema 时，跳过 manifest 字段校验。

6. Lint 告警
- 修复定位: 多文件（含 `src/cli/index.ts`, `src/daemon/host.ts`, `src/daemon/launcher.ts`, `src/router/learner.ts`, `src/companion/sqlite-runtime.ts`, `src/index.ts`, `src/gateway/index.ts` 等）
- 修复内容: 清理可选链、三元表达式、未使用符号、non-null assertion、`any` 类型等告警。

7. 自动化任务存在越界执行风险（高）
- 风险维度: 安全合规 / 架构完整性 / 用户体验
- 问题定位: `miya-src/src/automation/service.ts`
- 问题现象:
  - 可配置 `cwd` 未限制在项目目录，存在越界工作目录执行面。
  - `timeoutMs` 未做边界归一化，异常值可能导致任务“秒超时”或资源占用异常。
  - 空命令可被写入任务，运行时才失败，错误反馈滞后。
- 修复内容:
  - 新增命令文本校验：拒绝空命令、空任务名。
  - 新增 `cwd` 目录约束：仅允许项目目录内路径，越界在创建阶段拒绝。
  - 新增超时归一化：统一限制在 `[1000ms, 6h]`。
  - 对历史遗留不安全 `cwd` 做运行期降级：自动回退到项目目录并写入告警，不中断服务。
- 对应测试:
  - `miya-src/test/unit/automation-service.test.ts`
  - 覆盖用例: 越界 cwd 拒绝、cwd/timeout 归一化、遗留状态降级、空命令拒绝。

8. 工具动作审计账本可伪造/低熵签名风险（高）
- 风险维度: 安全渗透 / 合规审计追踪 / 灾难恢复
- 问题定位: `miya-src/src/gateway/kernel/action-ledger.ts`
- 问题现象:
  - `replayToken` 在未配置环境变量时使用固定默认 secret，令牌可预测。
  - `inputHash` 基于摘要文本而非完整参数，存在摘要碰撞导致审计指纹失真。
  - 缺少链路完整性验证入口，账本被篡改或混入坏行时难以自动发现。
- 修复内容:
  - 引入项目级持久化随机 secret（`tool-action-ledger.secret`），替代固定默认 secret。
  - `inputHash` 改为稳定序列化后的完整参数哈希，降低碰撞与伪造空间。
  - 新增 `verifyToolActionLedger`，支持检测 malformed JSON、`previousHash` 断链与 `entryHash` 篡改。
- 对应测试（全部放 `test`）:
  - `miya-src/test/security/action-ledger-security.test.ts`
  - `miya-src/test/disaster-recovery/action-ledger-resilience.test.ts`
  - `miya-src/test/compliance/action-ledger-audit-trail.test.ts`
  - `miya-src/test/performance/action-ledger-benchmark.test.ts`
  - `miya-src/test/integration/ecosystem-compatibility.test.ts`

9. 控制平面静态资源路径与生命周期参数容错缺陷（高）
- 风险维度: 网关控制平面架构 / 守护进程生命周期管理 / 本地化与可访问性
- 问题定位:
  - `miya-src/src/gateway/control-ui-shared.ts`
  - `miya-src/src/gateway/control-ui.ts`
  - `miya-src/src/daemon/launcher.ts`
  - `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - `MIYA_GATEWAY_UI_BASE_PATH` 对 `..`、反斜杠和重复分隔符缺少归一化约束，存在路由边界歧义。
  - 控制面资源请求未先做 URL 解码再做安全校验，编码后的 `..`/`\` 组合可绕过简单规则。
  - daemon 若读取到非法环境变量（如 `NaN`），背压阈值和冷却时间可能退化为 `NaN`，破坏生命周期保护。
  - 控制台时间格式固定 `zh-CN`，且成功/复制提示无语义化 live region，不利于本地化与读屏可访问性。
- 修复内容:
  - BasePath 统一规范化：拒绝 `.`/`..`/空字节，统一反斜杠和多斜杠。
  - 控制面请求路径先 `decodeURIComponent` 再执行安全判定，补强反斜杠和根目录逃逸拦截。
  - daemon 引入数值归一化函数（finite + clamp），统一兜底 pending/failures/cooldown/timeout 参数。
  - UI 改为运行时 locale 日期格式化，并为关键反馈补充 `aria-live` 语义通告。
- 对应测试:
  - `miya-src/src/gateway/control-ui.test.ts`
  - `miya-src/src/daemon/launcher.test.ts`
  - `miya-src/test/unit/gateway-ui-a11y-localization.test.ts`

## 回归命令（全部通过）
- `opencode debug config`
- `opencode debug skill`
- `opencode debug paths`
- `bun run typecheck`
- `bun run lint`
- `bun run doc:lint`
- `bun run check:contracts`
- `bun run check:no-regression`
- `bun run test`
- `bun run test:unit`
- `bun run test:integration`
- `bun run test:regression`
- `bun run test:adversarial`
- `bun run test:performance`
- `bun run test:e2e`
- `bun run test:coverage`
- `bun run test:coverage:core`
- `bun run test:integration:report`
- `bun run test:ci`
- `bun test test/unit/automation-service.test.ts --timeout 30000`
