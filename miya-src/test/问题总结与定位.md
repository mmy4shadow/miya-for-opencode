# 问题清单与具体定位

## 当前状态
- 截至 2026-02-19，本文件原列问题已全部修复并回归通过。
- 2026-02-19 六维审计新增 1 个高风险问题，已修复并补测通过。
- 2026-02-19 三专项审计（多智能体编排 / 内存系统 / 训练管道）新增 3 个问题，已修复并补测通过。
- 2026-02-19 六方向安全专项（桌面控制 / 出站安全 / 策略决策 / 证据包 / Kill-Switch / 审批疲劳）新增 3 个问题，已修复并补测通过。
- 2026-02-19 九维补充审计（人格语气 / 生态桥接 / 诊断观测 / 配置与迁移 / 占位符与部分实现）新增 2 个问题，已修复并补测通过。
- 2026-02-19 九方向复审（六智能体协作 / 网关域隔离 / 桌面控制 / 训练管道 / 内存反思 / 多模态 / 视觉ASR / 人格模式 / 计划任务）新增 2 个问题，已修复并补测通过。
- 2026-02-19 七维审计（无效实现 / 集成边界 / 状态机与错误处理 / 并发竞态 / 资源泄漏 / 安全扫描）新增 2 个高风险问题，已修复并补测通过。
- 2026-02-19 七维复审（人格模式 / 计划任务 / 策略审批 / Kill-Switch / 证据包 / 审批疲劳 / 生态桥接）新增 1 个问题，已修复并补测通过。
- 2026-02-19 十一向审计（守护进程生命周期 / 网关背压 / 配置有效性 / 诊断与健康检查 / 回归+性能执行 / 测试迁移整合 / 占位符深扫 / 事件处理器有效性 / 网关域方法实现深度）新增 1 个问题，已修复并补测通过。
- 2026-02-19 七方向专项审计（错误消息可操作性 / 跨组件状态一致性 / 并发用户操作处理 / 失败路径资源清理 / 边界数据验证 / 超时处理完整性 / 部分失败处理）新增 8 个问题，已修复并补测通过。
- 2026-02-19 九维交互完整性审计（通知系统 / 首次引导 / 键盘可达 / 搜索筛选 / 批量操作 / 实时状态 / 导入导出 / 上下文帮助 / 性能感知）新增 9 个可用性缺口，已修复并补测通过。

## 2026-02-19 九维交互完整性审计（Gateway UI）

33. 通知系统可追溯性不足（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 原实现仅显示瞬时 toast，后发消息会覆盖先发消息，缺少可回看通知队列。
- 修复内容:
  - 新增 `notifications` 队列与通知中心面板，保留最近 12 条并支持清空。

34. 首次用户缺少明确引导（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 首次打开无流程指引，新用户不清楚先看连接状态还是先做权限与任务检查。
- 修复内容:
  - 新增首次引导卡片，使用 `miya_gateway_onboarding_done` 记录完成状态。

35. 键盘导航与可访问性不足（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 缺少快捷导航与搜索焦点快捷键，侧边导航未标注当前页语义。
- 修复内容:
  - 新增 `Alt+1~4` 页面切换、`/` 搜索聚焦、`aria-current` 与 skip link。

36. 搜索与筛选能力不完整（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 作业中心与记忆库仅支持状态/域筛选，无法文本检索目标记录。
- 修复内容:
  - 新增任务/记忆文本搜索，支持与原有筛选组合。

37. 批量操作缺失（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 记忆操作仅支持单条处理，批量确认/归档效率低。
- 修复内容:
  - 新增可见项全选、批量确认、批量归档/取消归档。

38. 实时状态更新感知弱（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 虽有轮询，但无“最近刷新时间/刷新中”反馈，用户难判断界面是否卡住。
- 修复内容:
  - 新增刷新中状态、最近更新时间相对时间展示与刷新防重入。

39. 数据导出/导入链路不完整（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 仅支持单任务日志导出，记忆数据缺少导入与批量导出。
- 修复内容:
  - 新增记忆导出（选中/全部）与 JSON 导入（调用 `companion.memory.add`）。

40. 上下文帮助系统缺失（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 帮助文案固定且分散，无法根据当前页面提供操作建议。
- 修复内容:
  - 新增 `contextHelp`，按当前视图输出动态提示并联动当前错误上下文。

41. 性能感知优化不足（中）
- 问题定位: `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 高频刷新时缺少显式进度感知，用户误判为界面无响应。
- 修复内容:
  - 在主头部显示自动刷新节奏、刷新中状态与最后更新时间，降低“卡住”感知。
- 对应测试:
  - `miya-src/test/unit/gateway-ui-nine-aspects-completeness.test.ts`
  - `miya-src/test/unit/gateway-ui-a11y-localization.test.ts`
  - `miya-src/gateway-ui/src/App.behavior.test.tsx`

## 2026-02-19 Psyche 冲突复核（先校逻辑，再改代码）

1. `PLAY` 状态与 `epsilon` 探索冲突（高）
- 冲突点:
  - 旧逻辑中 `epsilon` 探索可把 `PLAY` 的 `defer` 强行转为 `allow`，与“游戏中默认不打扰”目标冲突。
- 修复定位:
  - `miya-src/src/daemon/psyche/consult.ts`
  - `miya-src/src/gateway/index.ts`
  - `miya-src/src/daemon/client.ts`
  - `miya-src/src/daemon/host.ts`
- 修复内容:
  - 新增 `allowPlayCompanion` 开关；默认 `PLAY` 不探索、不放行。
  - 仅当显式开启游戏陪伴时，才允许 `PLAY` 状态进入可发送路径。
  - 网关守门员模式新增 `playCompanionEnabled`，并透传 daemon consult。

2. `GetLastInputInfo` 计时口径冲突（高）
- 冲突点:
  - 旧实现直接 `GetTickCount64 - dwTime`，未处理 32-bit tick 回绕与异常回跳，可能制造“假输入/假空闲”。
- 修复定位:
  - `miya-src/src/daemon/psyche/sensors/input.ts`
- 修复内容:
  - 改为 `GetTickCount` 32-bit 回绕安全差分。
  - 对 idle 大幅回跳且无实时输入场景做异常钳制，输出 `input_idle_clock_anomaly` 限制标记。

3. 慢脑自动训练时机冲突（高）
- 冲突点:
  - 旧逻辑在 daemon 20s worker tick 上持续尝试自动重训（虽有间隔保护），与“默认只记录、周期重训”目标冲突。
- 修复定位:
  - `miya-src/src/daemon/service.ts`
  - `miya-src/src/gateway/index.ts`
- 修复内容:
  - daemon 新增周期重训配置读取（`gateway-psyche-mode.json` + 环境变量覆盖）。
  - 默认关闭自动重训；开启后按 `periodicRetrainIntervalHours + periodicRetrainMinOutcomes` 触发。
  - 网关模式新增 `periodicRetrainEnabled/periodicRetrainIntervalHours/periodicRetrainMinOutcomes`。

4. 策略优先级冲突（中）
- 冲突点:
  - 反事实策略可在 `critical + allow` 场景仍给出等待建议，和高优先级即时触达目标冲突。
- 修复定位:
  - `miya-src/src/daemon/psyche/proactivity/policy.ts`
- 修复内容:
  - `critical + baseDecision=allow` 强制 `send_now`，避免关键通知被“时机策略”反向稀释。
- 2026-02-19 五向专项审计（性能回归 / 测试结构 / 审计报告 / 配置漂移 / 事件完整性）新增 4 个问题，已修复并补测通过。

## 已修复问题（含定位）

1. `opencode debug config/skill` schema 报错
- 修复定位: `miya-src/opencode.json`
- 修复内容: 改为 OpenCode config schema（`https://opencode.ai/config.json`）并使用 `plugin` 配置。

2. 分类测试脚本空目录失败
- 修复定位:
  - `miya-src/test/integration/integration-smoke.test.ts`
  - `miya-src/test/regression/regression-bridge.test.ts`
  - `miya-src/test/adversarial/adversarial-bridge.test.ts`
  - `miya-src/test/performance/performance-smoke.test.ts`
  - `miya-src/test/e2e/e2e-smoke.test.ts`
- 修复内容: 补齐 5 个分类目录测试入口，脚本可执行。

3. 覆盖率脚本 reporter 不兼容 Bun
- 修复定位: `miya-src/package.json`
- 修复内容: `test:coverage`、`test:coverage:core` 从 `html` 改为 `text + lcov`。

4. 集成报告脚本失败（runtime 超时/daemon_ws_closed）
- 修复定位: `miya-src/tools/run-integration-suite.ts`
- 修复内容: 统一执行 `test/integration`，增加 timeout，默认使用 `MIYA_MULTIMODAL_TEST_MODE=1` 冒烟路径，报告稳定生成。

5. `doc:lint` 与 `opencode.json` 新口径冲突
- 修复定位: `miya-src/tools/doc-lint.ts`
- 修复内容: 当 `opencode.json` 为 config schema 时，跳过 manifest 字段校验。

6. Lint 告警
- 修复定位: 多文件（含 `src/cli/index.ts`, `src/daemon/host.ts`, `src/daemon/launcher.ts`, `src/router/learner.ts`, `src/companion/sqlite-runtime.ts`, `src/index.ts`, `src/gateway/index.ts` 等）
- 修复内容: 清理可选链、三元表达式、未使用符号、non-null assertion、`any` 类型等告警。

7. 自动化任务存在越界执行风险（高）
- 风险维度: 安全合规 / 架构完整性 / 用户体验
- 问题定位: `miya-src/src/automation/service.ts`
- 问题现象:
  - 可配置 `cwd` 未限制在项目目录，存在越界工作目录执行面。
  - `timeoutMs` 未做边界归一化，异常值可能导致任务“秒超时”或资源占用异常。
  - 空命令可被写入任务，运行时才失败，错误反馈滞后。
- 修复内容:
  - 新增命令文本校验：拒绝空命令、空任务名。
  - 新增 `cwd` 目录约束：仅允许项目目录内路径，越界在创建阶段拒绝。
  - 新增超时归一化：统一限制在 `[1000ms, 6h]`。
  - 对历史遗留不安全 `cwd` 做运行期降级：自动回退到项目目录并写入告警，不中断服务。
- 对应测试:
  - `miya-src/test/unit/automation-service.test.ts`
  - 覆盖用例: 越界 cwd 拒绝、cwd/timeout 归一化、遗留状态降级、空命令拒绝。

8. 工具动作审计账本可伪造/低熵签名风险（高）
- 风险维度: 安全渗透 / 合规审计追踪 / 灾难恢复
- 问题定位: `miya-src/src/gateway/kernel/action-ledger.ts`
- 问题现象:
  - `replayToken` 在未配置环境变量时使用固定默认 secret，令牌可预测。
  - `inputHash` 基于摘要文本而非完整参数，存在摘要碰撞导致审计指纹失真。
  - 缺少链路完整性验证入口，账本被篡改或混入坏行时难以自动发现。
- 修复内容:
  - 引入项目级持久化随机 secret（`tool-action-ledger.secret`），替代固定默认 secret。
  - `inputHash` 改为稳定序列化后的完整参数哈希，降低碰撞与伪造空间。
  - 新增 `verifyToolActionLedger`，支持检测 malformed JSON、`previousHash` 断链与 `entryHash` 篡改。
- 对应测试（全部放 `test`）:
  - `miya-src/test/security/action-ledger-security.test.ts`
  - `miya-src/test/disaster-recovery/action-ledger-resilience.test.ts`
  - `miya-src/test/compliance/action-ledger-audit-trail.test.ts`
  - `miya-src/test/performance/action-ledger-benchmark.test.ts`
  - `miya-src/test/integration/ecosystem-compatibility.test.ts`

9. 控制平面静态资源路径与生命周期参数容错缺陷（高）
- 风险维度: 网关控制平面架构 / 守护进程生命周期管理 / 本地化与可访问性
- 问题定位:
  - `miya-src/src/gateway/control-ui-shared.ts`
  - `miya-src/src/gateway/control-ui.ts`
  - `miya-src/src/daemon/launcher.ts`
  - `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - `MIYA_GATEWAY_UI_BASE_PATH` 对 `..`、反斜杠和重复分隔符缺少归一化约束，存在路由边界歧义。
  - 控制面资源请求未先做 URL 解码再做安全校验，编码后的 `..`/`\` 组合可绕过简单规则。
  - daemon 若读取到非法环境变量（如 `NaN`），背压阈值和冷却时间可能退化为 `NaN`，破坏生命周期保护。
  - 控制台时间格式固定 `zh-CN`，且成功/复制提示无语义化 live region，不利于本地化与读屏可访问性。
- 修复内容:
  - BasePath 统一规范化：拒绝 `.`/`..`/空字节，统一反斜杠和多斜杠。
  - 控制面请求路径先 `decodeURIComponent` 再执行安全判定，补强反斜杠和根目录逃逸拦截。
  - daemon 引入数值归一化函数（finite + clamp），统一兜底 pending/failures/cooldown/timeout 参数。
  - UI 改为运行时 locale 日期格式化，并为关键反馈补充 `aria-live` 语义通告。
- 对应测试:
  - `miya-src/src/gateway/control-ui.test.ts`
  - `miya-src/src/daemon/launcher.test.ts`
  - `miya-src/test/unit/gateway-ui-a11y-localization.test.ts`

10. 多智能体编排容错不足：`temperature` override 可被非有限值污染（中）
- 风险维度: Multi-Agent Orchestration
- 问题定位: `miya-src/src/agents/index.ts`
- 问题现象:
  - `applyOverrides` 对 `temperature` 仅判断 `!== undefined`，未过滤 `NaN/Infinity` 与异常值。
  - 在运行时非 schema 路径注入配置场景下，可能把 agent 温度污染为无效值，影响编排稳定性。
- 修复内容:
  - 增加有限数校验与边界归一化，统一限制到 `[0, 2]`，非法值回退保留原温度。
- 对应测试:
  - `miya-src/test/unit/multi-agent-orchestration.test.ts`

11. 内存系统读盘完整性缺陷：损坏记录可导致检索崩溃（高）
- 风险维度: Memory System Architecture
- 问题定位: `miya-src/src/companion/memory-vector.ts`
- 问题现象:
  - 反序列化时虽计算了 `text` 的字符串回退，但未写回对象；损坏 JSON 可保留非字符串 `text`。
  - `embedding` 缺少稳健清洗，异常值可污染检索分数通道。
  - 读取损坏 memory store 时，`normalizeText`/检索链路存在崩溃风险。
- 修复内容:
  - 强制写回规范化 `id/text/source/embedding/score/timestamps`。
  - `embedding` 仅保留有限数或可解析数字字符串，其余剔除。
  - 对关键字段提供安全兜底值，确保损坏数据可降级读取而非中断。
- 对应测试:
  - `miya-src/test/unit/memory-system-architecture.test.ts`

12. 训练管道参数解析脆弱：非法环境变量导致入口阶段崩溃（高）
- 风险维度: Training Pipeline Security & Integrity
- 问题定位:
  - `miya-src/python/train_sovits.py`
  - `miya-src/python/train_flux_lora.py`
- 问题现象:
  - 使用 `int(_env(...)) / float(_env(...))` 直接解析，异常字符串会在 parser 构建阶段抛异常退出。
  - 训练入口无法稳定返回结构化错误/降级行为，破坏流水线完整性。
- 修复内容:
  - 新增 `_env_int/_env_float` 安全解析函数，非法输入自动回退默认值。
  - 保证脚本在坏环境变量下仍可进入正常流程（含 dry-run 冒烟）。
- 对应测试:
  - `miya-src/test/unit/training-pipeline-integrity.test.ts`

13. 出站通道审批票据未强校验，存在过期票据绕过执行面（高）
- 风险维度: Outbound Channel Security / Policy Engine Decision Making / Approval Fatigue Mitigation
- 问题定位: `miya-src/src/channels/service.ts`
- 问题现象:
  - `approvalTickets` 仅用于审计摘要，不参与发送前门禁。
  - 在 `archAdvisorApproved=true` 条件下，缺失或过期票据仍可继续进入桌面发送流程。
- 修复内容:
  - 新增桌面出站票据校验：缺失、trace 为空、过期/非法时间戳均在发送前阻断。
  - 审计原因新增 `approval_ticket_invalid`，并附带标准化阻断码（`approval_ticket_*`）。
- 对应测试:
  - `miya-src/test/unit/outbound-approval-ticket-security.test.ts`

14. 证据采集仅覆盖 unstaged 变更，导致 staged/untracked 证据漏检（高）
- 风险维度: Evidence Bundle Standards
- 问题定位: `miya-src/src/safety/evidence.ts`
- 问题现象:
  - 变更文件列表仅来自 `git diff --name-only`，未覆盖 staged 与 untracked。
  - THOROUGH 档 secret scan 只扫描 unstaged diff，可能遗漏暂存区敏感信息。
- 修复内容:
  - 变更集合扩展为 unstaged + staged + untracked 三路合并去重。
  - THOROUGH 档 secret scan 同时扫描 `git diff` 与 `git diff --cached`。
  - 新增对应命令失败显式问题上报。
- 对应测试:
  - `miya-src/test/unit/evidence-bundle-standards.test.ts`

15. Kill-Switch 状态读取缺少类型归一化，非布尔值可能导致误判（中）
- 风险维度: Kill-Switch Mechanism
- 问题定位: `miya-src/src/safety/store.ts`
- 问题现象:
  - `readKillSwitch` 直接反序列化返回，`active` 若为字符串/数字时语义不稳定。
- 修复内容:
  - 新增 kill-switch 状态归一化：`active/reason/trace_id/activated_at` 统一校验与清洗。
  - 对非法 `activated_at` 自动剔除，避免下游误用。
- 对应测试:
  - `miya-src/test/unit/kill-switch-mechanism.test.ts`

16. 模式可观测统计对损坏持久化数据缺少数值硬化，可能输出 NaN/错计数（高）
- 风险维度: Diagnostic and Observability / Configuration Management
- 问题定位: `miya-src/src/gateway/mode-observability.ts`
- 问题现象:
  - `mode-observability.json` 被异常值污染时（字符串、`NaN`、负数），统计字段会被直接带入计算。
  - 记录新 turn 时存在字符串拼接风险（例如 `"9" + 1 => "91"`），导致指标漂移。
  - 指标计算可能输出 `NaN`，影响诊断面板与审计判断。
- 修复内容:
  - 新增 store 归一化：所有计数字段统一转为非负整数。
  - 新增 `lastMode/updatedAt/lastTurnID` 合法化清洗，坏值回退默认值。
  - 写盘前统一做归一化，确保后续读取稳定。
- 对应测试:
  - `miya-src/test/unit/diagnostic-observability-hardening.test.ts`

17. 生态桥接媒体域命名不一致，导致权限元数据语义偏差（中）
- 风险维度: Ecosystem Bridge Integration / Backward Compatibility and Migration
- 问题定位: `miya-src/src/compat/ecosystem-bridge-registry.ts`
- 问题现象:
  - `open-llm-vtuber` 条目使用 `media_generation` 命名，与策略域 `media_generate` 不一致。
  - required domain 错配为 `memory_write`，与媒体能力实际侧效应不对齐。
- 修复内容:
  - 统一媒体侧效应命名为 `media_generate`。
  - required domain 调整为 `media_generate`，与策略域一致。
  - 增补注册表一致性测试与深拷贝防变异测试。
- 对应测试:
  - `miya-src/test/unit/ecosystem-bridge-integration-consistency.test.ts`
  - `miya-src/test/unit/partial-implementation-gap-analysis.test.ts`（差距文档化守门）

16. 计划任务日程推进缺陷：scheduler 执行后未刷新 `nextRunAt` 导致重复触发（高）
- 风险维度: Scheduled Tasks and Proactive Behavior
- 问题定位: `miya-src/src/automation/service.ts`
- 问题现象:
  - `executeJobInState` 在 `trigger='scheduler'` 分支不会更新 `nextRunAt`。
  - 到点任务执行成功后仍保持“已过期”时间戳，可能每 30 秒调度周期重复执行一次。
- 修复内容:
  - 统一在任务执行后刷新 `nextRunAt`（包括 scheduler/manual/approval 分支），确保每日任务只推进到下一个日程窗口。
- 对应测试:
  - `miya-src/test/unit/automation-service.test.ts`
  - 覆盖用例: scheduler 执行后推进 `nextRunAt` 且二次 `tick` 不重复运行。

17. 网关方法域隔离绕过：域注册可覆盖既有方法且未触发校验（高）
- 风险维度: Gateway Method Domain Separation / Six-Agent Collaboration Testing
- 问题定位:
  - `miya-src/src/gateway/methods/channels.ts`
  - `miya-src/src/gateway/methods/companion.ts`
  - `miya-src/src/gateway/methods/memory.ts`
  - `miya-src/src/gateway/methods/nodes.ts`
  - `miya-src/src/gateway/methods/security.ts`
- 问题现象:
  - 域注册逻辑仅校验“新增方法名”的前缀，若回调覆盖了已存在方法（同名 set），`added` 为空，前缀校验无法发现越权覆盖。
- 修复内容:
  - 注册前后比对 handler 引用，检测并阻断任何既有方法覆盖，抛出 `gateway_domain_registration_override:*`。
- 对应测试:
  - `miya-src/test/unit/gateway-method-domain-separation.test.ts`
  - 覆盖用例: 覆盖既有方法被拒绝、各域合法前缀注册通过。

18. 出站策略字段存在“无效实现”：`allowedChannels` 配置未生效（高）
- 风险维度: Ineffective Implementation Detection / Integration Boundary Testing / Security Vulnerability Scanning
- 问题定位:
  - `miya-src/src/channels/service.ts`
- 问题现象:
  - `policy.outbound.allowedChannels` 仅定义在 schema 中，发送路径未消费该字段。
  - 即使策略将 `qq/wechat` 禁用，运行时仍会继续进入桌面出站链路。
- 修复内容:
  - 在 `sendMessage` 增加策略边界校验：桌面通道必须存在于 `allowedChannels`，否则立即阻断并审计 `outbound_blocked:channel_not_allowed_by_policy:*`。
- 对应测试:
  - `miya-src/test/unit/channel-policy-hardening.test.ts`
  - 覆盖用例: 策略禁用 `qq` 时，`qq` 出站被阻断。

19. 策略脏值可导致节流/去重失效（高）
- 风险维度: Error Handling Completeness / Concurrency and Race Condition Testing / Resource Leak Detection / Security Vulnerability Scanning
- 问题定位:
  - `miya-src/src/policy/index.ts`
  - `miya-src/src/channels/service.ts`
- 问题现象:
  - `minIntervalMs/burstWindowMs/burstLimit/duplicateWindowMs` 被字符串或非法值污染时，`Number(...)` 可产生 `NaN`。
  - 在 `NaN` 分支下，节流与去重守卫可静默退化，导致高频重放不被拦截，放大竞态与资源占用风险。
- 修复内容:
  - `readPolicy` 增加强类型归一化：`domains/outbound` 全字段清洗，非法值回退默认安全值。
  - `channels` 发送链路增加运行时数值硬化（finite + clamp），避免脏配置绕过节流与去重。
- 对应测试:
  - `miya-src/test/unit/channel-policy-hardening.test.ts`
  - 覆盖用例: 非法数值配置下仍触发节流阻断；策略字段归一化后输出稳定。

20. 配置漂移容错缺陷：损坏 `miya.jsonc` 会吞掉有效 `miya.json`（高）
- 风险维度: Configuration Drift Detection
- 问题定位:
  - `miya-src/src/config/loader.ts`
- 问题现象:
  - 配置加载路径优先选 `miya.jsonc`，一旦该文件损坏，流程直接返回空配置，不会回退到同目录下有效的 `miya.json`。
  - 导致“配置存在但运行态丢失”的漂移症状，且排障成本高。
- 修复内容:
  - 新增按优先级回退加载：优先 `.jsonc`，无效时自动继续尝试 `.json`。
  - 保留 `.jsonc` 优先级语义，不影响双文件都有效时的预期行为。
- 对应测试:
  - `miya-src/src/config/loader.test.ts`
  - 覆盖用例: `.jsonc` 损坏 + `.json` 有效时成功回退加载。

21. 权限事件模式字段污染：空值/脏值透传破坏事件语义（中）
- 风险维度: Event System Integrity
- 问题定位:
  - `miya-src/src/contracts/permission-events.ts`
- 问题现象:
  - `pattern` 数组直接 `String(...)` 后写入事件，空白字符串、`null/undefined` 会进入事件载荷。
  - 下游审计/统计读取模式列表时语义噪声增大，影响事件完整性。
- 修复内容:
  - 统一 `pattern` 归一化：去除 `null/undefined`、trim 空值、去重，仅保留有效模式。
  - 保持 canonical event 名称与状态字段规范不变。
- 对应测试:
  - `miya-src/test/unit/event-system-integrity.test.ts`
  - 覆盖用例: pattern 清洗去重、非法 status 丢弃、canonical 事件名校验。

22. 性能回归检测“形同空壳”：仅绝对阈值，缺失基线对比（中）
- 风险维度: Performance Regression Detection
- 问题定位:
  - `miya-src/test/performance/action-ledger-benchmark.test.ts`
  - `miya-src/test/baselines/benchmarks.json`
- 问题现象:
  - 仅使用固定上限（12s）无法捕获渐进式退化（例如 30%-80% 变慢但仍低于绝对上限）。
  - `test/config/test.config.ts` 中的 `baselinePath/regressionThreshold` 未被消费。
- 修复内容:
  - 为关键基准引入 baseline-aware 检测：基线耗时 + 回归百分比 + 抖动缓冲联合判定。
  - 支持 `MIYA_UPDATE_BASELINES=1` 显式更新基线，避免隐式漂移。
  - 新增基线文件 `test/baselines/benchmarks.json`。
- 对应测试:
  - `miya-src/test/performance/action-ledger-benchmark.test.ts`

23. 审计报告生成依赖手工维护，缺少机器可复现产物（中）
- 风险维度: Audit Report Generation / Test Organization and Structure
- 问题定位:
  - `miya-src/tools/audit-report-generator.ts`
  - `miya-src/test/unit/audit-report-generation.test.ts`
  - `miya-src/test/unit/test-organization-structure.test.ts`
- 问题现象:
  - 现有审计报告主要靠手工更新，容易与真实执行状态偏离。
  - 测试组织缺少结构守门，目录或分类退化时不易在 CI 早期发现。
- 修复内容:
  - 新增自动审计快照生成器：输出 `test/reports/audit-latest.md` 与 `test/reports/audit-latest.json`。
  - 新增 `bun run audit:report` 脚本入口。
  - 新增测试结构守门：按 `testCategories` 校验分类目录与最小测试覆盖。
- 对应测试:
  - `miya-src/test/unit/audit-report-generation.test.ts`
  - `miya-src/test/unit/test-organization-structure.test.ts`

24. 控制台路由解码健壮性缺陷：非法 URL 编码可导致 UI 崩溃（中）
- 风险维度: UI/UX Consistency / Accessibility Compliance
- 问题定位:
  - `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - `parseRoute` 直接调用 `decodeURIComponent`，当路径包含非法 `%` 编码时会抛 `URIError`，导致控制台视图初始化失败。
- 修复内容:
  - 新增 `safeDecodeRouteSegment`，对非法编码降级为原始片段，避免页面崩溃。
- 对应测试:
  - `miya-src/gateway-ui/src/App.behavior.test.tsx`

25. 网关方法域注册存在重复实现，增加维护漂移风险（中）
- 风险维度: Code Duplication and Maintainability / Technical Debt Quantification
- 问题定位:
  - `miya-src/src/gateway/methods/{channels,companion,memory,nodes,security}.ts`
- 问题现象:
  - 五个域文件重复了相同的域注册校验逻辑，后续修复需要多点同步，容易出现行为漂移。
- 修复内容:
  - 抽取共享实现 `miya-src/src/gateway/methods/domain-registration.ts`，各域仅保留前缀配置。
- 对应测试:
  - `miya-src/test/unit/technical-debt-quantification.test.ts`
  - `miya-src/test/unit/gateway-method-domain-separation.test.ts`

26. 多模态输入校验错误信息不具可操作性（中）
- 风险维度: Error Message Quality / Multimodal Generation (Image/Voice)
- 问题定位:
  - `miya-src/src/multimodal/image.ts`
  - `miya-src/src/multimodal/voice.ts`
- 问题现象:
  - 仅抛 `invalid_prompt` / `invalid_tts_text` / `invalid_voice_input`，缺少字段与修复提示，不利于定位前端/调用方错误。
- 修复内容:
  - 改为带字段语义的错误消息（如 `invalid_prompt:prompt must not be empty`）。
- 对应测试:
  - `miya-src/test/unit/multimodal-error-quality-and-asr-processing.test.ts`

27. ASR 事件构建缺少输入归一化与边界校验（中）
- 风险维度: Vision and ASR Processing / Type Safety and TypeScript Usage
- 问题定位:
  - `miya-src/src/media/transcribe.ts`
- 问题现象:
  - `mediaID/transcript/confidence` 未归一化，空值或非法数值可透传到事件总线。
- 修复内容:
  - 增加 `mediaID/transcript` 必填校验、`language` 清洗、`confidence` 有界归一化（0~1）。
- 对应测试:
  - `miya-src/test/unit/multimodal-error-quality-and-asr-processing.test.ts`

28. 六智能体协作缺少基线拓扑守门（中）
- 风险维度: Six-Agent Collaboration Testing
- 问题定位:
  - `miya-src/test/unit/six-agent-collaboration.test.ts`
- 问题现象:
  - 现有测试未显式保证六智能体基线（1~6）完整性，配置回归时可能静默缺失关键角色。
- 修复内容:
  - 新增六智能体拓扑与主路由模式验证测试。
- 对应测试:
  - `miya-src/test/unit/six-agent-collaboration.test.ts`

29. 审批疲劳计划包预算字段缺少有限数归一化，异常输入可写入 `NaN`（中）
- 风险维度: Approval Fatigue and Plan Bundle
- 问题定位:
  - `miya-src/src/autopilot/plan-bundle.ts`
- 问题现象:
  - `timeoutMs/maxRetriesPerCommand` 仅按 `typeof number` 分支处理，`NaN/Infinity` 会穿透进预算。
  - 结果可能出现 `budget.timeMs/retries = NaN`，影响审批与审计展示一致性。
- 修复内容:
  - 新增 `normalizeTimeoutMs/normalizeMaxRetries`，统一进行 finite 校验和边界钳制。
  - `timeoutMs` 默认回退 `60000` 并限制到 `[1000, 10min]`；`maxRetries` 默认 `1` 并限制到 `[0,3]`。
- 对应测试:
  - `miya-src/test/unit/approval-fatigue-plan-bundle-hardening.test.ts`

30. 网关背压参数对非法环境变量缺少有限数兜底，可能退化为 `NaN`（高）
- 风险维度: Gateway Backpressure and Queue Management / Configuration Effectiveness Audit
- 问题定位:
  - `miya-src/src/gateway/protocol.ts`
- 问题现象:
  - `maxInFlight/maxQueued/queueTimeoutMs` 直接用 `Number(env)`，当环境变量为 `NaN/非法字符串` 时可变成 `NaN`。
  - 在 `NaN` 分支下，背压比较与排队超时行为会异常，影响队列管理与诊断统计可靠性。
- 修复内容:
  - 新增有限数归一化与整数钳制函数，统一对背压参数做 fallback + 下界保护。
  - 构造函数改为使用归一化后的数值，保证非法配置不污染运行态。
- 对应测试:
  - `miya-src/src/gateway/protocol.test.ts`（新增 `normalizes invalid backpressure env values to safe defaults`）

31. 控制台审计时间线与证据区块被永久隐藏，造成审计追踪不可见（高）
- 风险维度: User Workflow Completeness / UI Feedback Loop Completeness / Audit Trail User Interface / Desktop Control Operation Transparency
- 问题定位:
  - `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - `系统时间线` 与 `Evidence Pack V5` 所在 section 使用 `hidden` 类名，用户无法在控制中枢看到审计链路与外发证据回放。
  - 权限请求上下文、训练进度、技能状态、配置发现入口缺少统一可见面板，导致排障路径不完整。
- 修复内容:
  - 取消审计时间线与证据区块的永久隐藏，使其默认可见。
  - 新增 4 个完整性面板：`用户工作流完整性与权限请求清晰度`、`错误恢复路径完整性与配置可发现性`、`训练进度可见性与技能管理用户体验`、`桌面控制操作透明度与审计追踪`。
- 对应测试:
  - `miya-src/gateway-ui/src/App.behavior.test.tsx`
  - 覆盖用例: 面板可见性、系统时间线可见、Evidence Pack 可见、训练进度展示。

32. 控制平面静态资源 404 退化为 HTML fallback，错误恢复路径不透明（中）
- 风险维度: Error Recovery Path Completeness / UI Feedback Loop Completeness / Configuration Discoverability Testing
- 问题定位:
  - `miya-src/src/gateway/control-ui.ts`
- 问题现象:
  - 对 `/assets/*` 丢失文件仍回退到 `index.html`，前端会收到错误 MIME 响应，难以定位真实问题。
  - 非法 URL 编码路径会被静默回退到首页，用户得不到明确错误反馈。
- 修复内容:
  - 资产请求缺失时返回 `404 Asset Not Found`，不再回退到 SPA 首页。
  - 非法 URL 编码请求返回 `400 Bad Request`，保留可诊断错误语义。
- 对应测试:
  - `miya-src/src/gateway/control-ui.test.ts`
  - 覆盖用例: `returns 404 for missing asset path...`、`returns 400 for malformed encoded route...`
  - `miya-src/test/unit/control-plane-completeness.test.ts`（10维快照契约完整性守门）

33. 自动化任务执行链路存在并发/超时/部分失败韧性缺陷（高）
- 风险维度: Error Message Actionability / State Consistency Across Components / Concurrent User Action Handling / Resource Cleanup on Failure Paths / Data Validation at Boundaries / Timeout Handling Completeness / Partial Failure Handling
- 问题定位:
  - `miya-src/src/automation/service.ts`
- 问题现象:
  - 同一任务可被手动重复触发并发执行，缺少任务级并发门禁，存在竞态写状态风险。
  - scheduler 遍历中若某任务异常会影响同轮后续任务处理，缺少任务级故障隔离。
  - 命令超时仅返回失败，不包含可执行修复建议（例如 timeoutMs 调整范围）。
  - 历史脏数据中的非法 `schedule.time` 会在执行路径抛错，导致状态更新与历史审计不稳定。
- 修复内容:
  - 增加任务级运行锁（`activeJobIDs`），阻断同任务并发手动/审批执行并输出 `job_execution_in_progress:*` 可操作错误。
  - scheduler 改为任务级 `try/catch`，单任务失败不会中断整轮 tick；失败写入标准化历史记录。
  - 超时失败追加 `command_timeout:*` 操作建议，明确 `timeoutMs` 调整方向和上限。
  - 执行前新增 `schedule.time` 边界校验（HH:mm）；非法值改为结构化失败结果并保底推进 `nextRunAt`，避免反复崩溃。
- 对应测试:
  - `miya-src/test/unit/automation-service.test.ts`
  - 覆盖用例: scheduler 部分失败隔离、同任务并发拦截、超时提示可操作且锁释放后可重跑。

34. 控制台记忆导入/批量操作在并发与部分失败场景下反馈不完整（中）
- 风险维度: Error Message Actionability / State Consistency Across Components / Concurrent User Action Handling / Data Validation at Boundaries / Partial Failure Handling
- 问题定位:
  - `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - UI 操作入口缺少统一并发门禁，快速重复触发时可能出现重复提交与状态抖动。
  - 记忆导入/批量操作采用“遇错即停”，部分成功场景缺少结构化反馈，用户无法明确成功/失败数量。
  - 导入边界缺少文件体积与行数限制，异常大输入可能导致前端卡顿与网关写入压力突增。
- 修复内容:
  - 新增 `action_in_progress` 门禁（ref 锁）阻断并发提交。
  - 导入与批量操作改为“逐条执行 + 失败收敛”，支持部分成功并输出 `partial_failure:*` 可操作错误。
  - 新增导入边界校验：文件大小上限 `2MB`、条目上限 `200`，超限返回明确错误码。
- 对应测试:
  - `miya-src/gateway-ui/src/App.behavior.test.tsx`
  - 覆盖用例: 超大导入文件可操作报错、部分导入失败的结构化反馈。

35. 作业中心与引导文案不一致：日志导出入口仅在任务详情页，列表页不可发现（中）
- 风险维度: Error Message Actionability / State Consistency Across Components / User Workflow Consistency
- 问题定位:
  - `miya-src/gateway-ui/src/App.tsx`
- 问题现象:
  - 引导文案提示“作业中心可导出日志”，但列表页仅有“查看详情”，导出入口隐藏在任务详情底部。
  - 用户按引导路径停留在列表页时会误判“没有日志导出功能”。
- 修复内容:
  - 在作业中心列表页工具栏新增 `导出最近日志` 一键入口。
  - 当列表为空时输出可操作错误：`没有可导出的任务日志，请先刷新或调整筛选条件。`。
- 对应测试:
  - `miya-src/gateway-ui/src/App.behavior.test.tsx`
  - 覆盖用例: 列表页快速导出入口可见、可触发导出并返回成功反馈。

## 回归命令（全部通过）
- `opencode debug config`
- `opencode debug skill`
- `opencode debug paths`
- `bun run typecheck`
- `bun run lint`
- `bun run doc:lint`
- `bun run check:contracts`
- `bun run check:no-regression`
- `bun run test`
- `bun run test:unit`
- `bun run test:integration`
- `bun run test:regression`
- `bun run test:adversarial`
- `bun run test:performance`
- `bun run test:e2e`
- `bun run test:ui`
- `bun run test:coverage`
- `bun run test:coverage:core`
- `bun run test:integration:report`
- `bun run test:ci`
- `bun test test/unit/automation-service.test.ts --timeout 30000`
- `bun test test/unit/multi-agent-orchestration.test.ts test/unit/memory-system-architecture.test.ts test/unit/training-pipeline-integrity.test.ts --timeout 30000`
- `bun test test/unit/automation-service.test.ts test/unit/gateway-method-domain-separation.test.ts --timeout 60000`
- `bun test test/unit/channel-policy-hardening.test.ts --timeout 60000`
- `bun test test/unit/channel-policy-hardening.test.ts src/channels/service.test.ts src/policy/index.test.ts --timeout 60000`
